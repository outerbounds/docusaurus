"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[874],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return f}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=p(n),f=o,m=d["".concat(l,".").concat(f)]||d[f]||u[f]||r;return n?a.createElement(m,s(s({ref:t},c),{},{components:n})):a.createElement(m,s({ref:t},c))}));function f(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,s=new Array(r);s[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var p=2;p<r;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4489:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return c},default:function(){return d}});var a=n(7462),o=n(3366),r=(n(7294),n(3905)),s=["components"],i={},l="Fake Documentation",p={unversionedId:"fake",id:"fake",title:"Fake Documentation",description:"Profiling your flows",source:"@site/docs/fake.mdx",sourceDirName:".",slug:"/fake",permalink:"/docs/fake",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/fake.mdx",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",next:{title:"Why Metaflow",permalink:"/docs/why"}},c=[{value:"Profiling your flows",id:"profiling-your-flows",children:[{value:"The <code>profile</code> context manager",id:"the-profile-context-manager",children:[],level:3},{value:"Saving Metrics",id:"saving-metrics",children:[],level:3}],level:2},{value:"The <code>--package-suffixes</code> argument",id:"the---package-suffixes-argument",children:[],level:2}],u={toc:c};function d(e){var t=e.components,n=(0,o.Z)(e,s);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"fake-documentation"},"Fake Documentation"),(0,r.kt)("h2",{id:"profiling-your-flows"},"Profiling your flows"),(0,r.kt)("p",null,"Tracking system metrics such as runtime is a great way to not only debug issues, but also get an early warning on things that may be amiss in your workflow. Below, we walk through some ways to profile your flows:"),(0,r.kt)("h3",{id:"the-profile-context-manager"},"The ",(0,r.kt)("inlineCode",{parentName:"h3"},"profile")," context manager"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"profile")," context manager helps you to measure the runtime of arbitrary blocks of your code and emit easy to understand logs."),(0,r.kt)("p",null,"For example, consider the ",(0,r.kt)("inlineCode",{parentName:"p"},"KmeansFlow")," flow we introduced earlier. If we wanted to measure the time it takes to train the model, we could add a the profile context manager to this flow:"),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"K means k"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"from metaflow import FlowSpec, step, Parameter, resources, conda_base, profile\n\n@conda_base(python='3.8.3', libraries={'scikit-learn': '0.24.1'})\nclass KmeansFlow(FlowSpec):\n\n    num_docs = Parameter('num-docs', help='Number of documents', default=1000000)\n\n    @resources(memory=4000)\n    @step\n    def start(self):\n        import scale_data\n        docs = scale_data.load_yelp_reviews(self.num_docs)\n        self.mtx, self.cols = scale_data.make_matrix(docs)\n        print(\"matrix size: %dx%d\" % self.mtx.shape)\n        self.next(self.train_kmeans)\n\n    @resources(cpu=16, memory=4000)\n    @step\n    # highlight-start\n    def train_kmeans(self):\n        from sklearn.cluster import KMeans\n        with profile('k-means'):\n            kmeans = KMeans(n_clusters=10,\n                            verbose=1,\n                            n_init=1)\n            kmeans.fit(self.mtx)\n        #label This line is not important\n        self.clusters = kmeans.labels_\n        self.next(self.end)\n    #highlight-end\n    @step\n    def end(self):\n        pass\n\nif __name__ == '__main__':\n    KmeansFlow()\n")),(0,r.kt)("p",null,"When we execute the flow, we can see the output logs the run time of the code within the context manager:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"2022-02-03 15:37:25.008 [6224/start/131587 (pid 15566)] Task is starting.\n2022-02-03 15:38:34.733 [6224/start/131587 (pid 15566)] matrix size: 650000x48177\n2022-02-03 15:38:44.653 [6224/start/131587 (pid 15566)] Task finished successfully.\n2022-02-03 15:38:45.296 [6224/train_kmeans/131588 (pid 15589)] Task is starting.\n2022-02-03 15:38:50.202 [6224/train_kmeans/131588 (pid 15589)] PROFILE: k-means starting\n...\n2022-02-03 15:39:30.140 [6224/train_kmeans/131588 (pid 15589)] PROFILE: k-means completed in 39939ms\n...\n")),(0,r.kt)("p",null,"You will notice the prefix ",(0,r.kt)("inlineCode",{parentName:"p"},"k-means")," that you supplied as an argument to ",(0,r.kt)("inlineCode",{parentName:"p"},"profile")," is included in the output. This helps you identify which block of code the measurement relates to."),(0,r.kt)("h3",{id:"saving-metrics"},"Saving Metrics"),(0,r.kt)("p",null,"Another feature of the ",(0,r.kt)("inlineCode",{parentName:"p"},"profile")," context manager is the ability to save the runtime to a dictionary for later use. Consider the below flow that benchmarks the load time of different data structures with ",(0,r.kt)("inlineCode",{parentName:"p"},"profile")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import os\nfrom metaflow import FlowSpec, step, conda_base, resources, S3, profile\n\nURL = 's3://ursa-labs-taxi-data/2014/12/data.parquet'\n\n@conda_base(python='3.8.10',\n        libraries={'pyarrow': '5.0.0', 'pandas': '1.3.2'})\nclass ParquetBenchmarkFlow(FlowSpec):\n\n    @step\n    def start(self):\n        import pyarrow.parquet as pq\n        with S3() as s3:\n            res = s3.get(URL)\n            table = pq.read_table(res.path)\n            os.rename(res.path, 'taxi.parquet')\n        table.to_pandas().to_csv('taxi.csv')\n        self.stats = {}\n        self.next(self.load_csv, self.load_parquet, self.load_pandas)\n\n    @step\n    def load_csv(self):\n        # highlight-start\n        with profile('load_csv', stats_dict=self.stats):\n            import csv\n            with open('taxi.csv') as csvfile:\n                for row in csv.reader(csvfile):\n                    pass\n        # highlight-end\n\n        self.next(self.join)\n\n    @step\n    def load_parquet(self):\n        # highlight-start\n        with profile('load_parquet', stats_dict=self.stats):\n            import pyarrow.parquet as pq\n            table = pq.read_table('taxi.parquet')\n        # highlight-end\n        self.next(self.join)\n\n    @step\n    def load_pandas(self):\n        # highlight-start\n        with profile('load_pandas', stats_dict=self.stats):\n            import pandas as pd\n            df = pd.read_parquet('taxi.parquet')\n        # highlight-end\n        self.next(self.join)\n\n    @step\n    def join(self, inputs):\n        for inp in inputs:\n            print(list(inp.stats.items())[0])\n        self.next(self.end)\n\n    @step\n    def end(self):\n        pass\n\nif __name__ == '__main__':\n    ParquetBenchmarkFlow()\n")),(0,r.kt)("p",null,"The output of this flow is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"...\n2022-02-03 23:04:00.640 [6228/join/131602 (pid 19420)] ('load_csv', 25535)\n2022-02-03 23:04:00.677 [6228/join/131602 (pid 19420)] ('load_pandas', 1912)\n2022-02-03 23:04:00.710 [6228/join/131602 (pid 19420)] ('load_parquet', 1177)\n...\n")),(0,r.kt)("h2",{id:"the---package-suffixes-argument"},"The ",(0,r.kt)("inlineCode",{parentName:"h2"},"--package-suffixes")," argument"),(0,r.kt)("p",null,"Suppose your project structure looks like this, and ",(0,r.kt)("inlineCode",{parentName:"p"},"[flow.py](http://flow.py)")," depends on ",(0,r.kt)("inlineCode",{parentName:"p"},"data/.config")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"data/vocabulary.txt")," :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"flow.py\n|_data/\n    |_ .config\n    |_ vocabulary.txt\n")),(0,r.kt)("p",null,"In order for these files to be included in the ",(0,r.kt)("inlineCode",{parentName:"p"},"code package")," , you must use the ",(0,r.kt)("inlineCode",{parentName:"p"},"--package-suffixes")," argument. If we look at the help we can see what this argument does:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash",metastring:"focus=11:13",focus:"11:13"},"> python nbflow.py --help\n\nOptions:\n  --quiet / --not-quiet           Suppress unnecessary messages  [default:\n                                  False]\n\n  --metadata [local|service]      Metadata service type  [default: service]\n  --environment [local|conda]     Execution environment type  [default: local]\n  --datastore [local|s3]          Data backend type  [default: s3]\n  --datastore-root TEXT           Root path for datastore\n  --package-suffixes TEXT         A comma-separated list of file suffixes to\n                                  include in the code package.  [default:\n                                  .py,.R,.RDS]\n\n  --with TEXT                     Add a decorator to all steps. You can\n                                  specify this option multiple times to attach\n                                  multiple decorators in steps.\n\n  --pylint / --no-pylint          Run Pylint on the flow if pylint is\n                                  installed.  [default: True]\n\n  --coverage                      Measure code coverage using coverage.py.\n                                  [default: False]\n\n  --event-logger [debugLogger|nullSidecarLogger]\n                                  type of event logger used  [default:\n                                  nullSidecarLogger]\n\n  --monitor [debugMonitor|nullSidecarMonitor]\n                                  Monitoring backend type  [default:\n                                  nullSidecarMonitor]\n\n  --help                          Show this message and exit.\n\nCommands:\n  batch           Commands related to AWS Batch.\n  card            Commands related to @card decorator.\n  check           Check that the flow is valid (default).\n  dump            Get data artifacts of a task or all tasks in a step.\n  help            Show all available commands.\n  init            Internal command to initialize a run.\n  kubernetes      Commands related to Kubernetes on Amazon EKS.\n  logs            Show stdout/stderr produced by a task or all tasks in a...\n  output-dot      Visualize the flow with Graphviz.\n  output-raw      Output internal state of the flow graph.\n  package         Commands related to code packages.\n  resume          Resume execution of a previous run of this flow.\n  run             Run the workflow locally.\n  show            Show structure of the flow.\n  step            Internal command to execute a single task.\n  step-functions  Commands related to AWS Step Functions.\n  version         Print the Metaflow version\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"For example")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},'python flow.py --package-suffixes=".txt" run')," will instruct Metaflow to upload ",(0,r.kt)("inlineCode",{parentName:"p"},"vocabulary.txt")," as part of the code package."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"package-suffixes")," allows you to specify more than one file extension to include. For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Some cli command\n")),(0,r.kt)("p",null,"results in this"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Some output\n")))}d.isMDXComponent=!0}}]);